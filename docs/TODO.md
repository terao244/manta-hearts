# Manta 開発TODO

このドキュメントは、Mantaプロジェクトの詳細な開発タスクリストです。
各タスクは完了時にチェックし、git commitを行います。

## 🎯 現在の進捗状況（2025/05/31更新）

### ✅ 完了したPhase
- **Phase 1: 基盤構築** - Docker環境、TypeScript設定、プロジェクト構造、Prettier・Jest設定完了
- **Phase 2: データベース層構築** - Prismaスキーマ、シードデータ、52枚カード定義
- **Phase 3: バックエンドAPI基盤** - Express + Socket.io、エラーハンドリング、ロギング、Players API、PrismaService、Repository層
- **Phase 4: ゲームロジック実装** - Card、Deck、Player、GameState、GameEngine（120個のテスト全て合格）
- **Phase 5: Socket.io通信層** - GameServiceとSocket.ioハンドラー統合、リアルタイム通信
- **Phase 6: バックエンドサービス層** - ゲーム永続化、モック戦略改善、依存性注入パターン（166個のテスト全て合格）
- **Phase 7: フロントエンドゲーム画面** - ゲームボード、カード操作UI、リアルタイム表示、Socket.io統合
- **Phase 7.1: 通信問題修正** - Socket.io複数接続問題解決、joinGame機能修正、型安全性向上
- **Phase 7.2: UI表示問題修正** - Reactコンポーネントkey警告エラー解決、プレイヤー情報表示改善
- **Phase 8: ゲーム画面実装** - 東西南北配置、手札表示改善、自動配布、リアルタイム同期強化
- **Phase 9: カード操作UI詳細（完了）** - 有効カードハイライト、カードホバー効果、カード選択UI改善、カード交換フェーズUI実装
- **Phase 10: ゲーム進行機能（完了）** - カードプレイ処理強化、トリック勝者判定、スコア計算、アニメーション追加

### ✅ 最新の完了項目（2025/06/01）
- **手札ソート順変更機能** - スート順序をクラブ→ダイヤ→スペード→ハートに変更、全60フロントエンドテスト正常通過
- **現在ハンド点数表示機能実装** - プレイヤーカードに累積点数と現在ハンド点数を区別表示、リアルタイム更新、0点も常時表示
- **Phase 10ゲーム進行機能完全実装** - カードプレイ処理強化、トリック表示改善、アニメーション追加、全171+30テスト正常通過
- **ゲーム終了点数設定機能** - 環境変数GAME_END_SCOREでデバッグ用30点設定可能
- **バグ修正: クラブの2強制プレイルール** - 2ハンド目以降で正常にクラブの2が強制される問題を修正

### 🚧 進行中のPhase  
なし（Phase 10完了）

### 📋 次の重点実装領域
- **Phase 11: データ永続化詳細** - ゲーム保存処理、リアルタイム同期、統計機能

### 🎮 動作確認可能な機能
- http://localhost:3000 でプレイヤー選択画面表示
- Socket.io接続状態のリアルタイム表示
- 4名固定プレイヤーでのログイン機能
- ゲームロビー画面（ゲーム参加機能）✅ **修正完了**
- ゲームボード画面（東西南北配置、手札表示、プレイヤー情報、スコア表示）✅ **大幅改善**
- カードコンポーネント（スート、ランク、ポイント表示）
- 手札コンポーネント（直感的ソート、カード選択、交換機能、情報表示）✅ **大幅改善**
- 4人揃った時の自動手札配布✅ **新機能**（全プレイヤーへの手札配布問題修正済み）
- 有効カードハイライト機能（リアルタイム判定、視覚的フィードバック）✅ **新機能**
- カードホバー効果とツールチップ（詳細情報表示、アニメーション）✅ **新機能**
- カード選択UI改善（プログレスバー、選択状況表示、アニメーション）✅ **新機能**
- カード交換フェーズUI（方向表示、進捗表示、完了フィードバック）✅ **新機能**
- データベース（PostgreSQL）との接続・データ投入
- 完全なゲームロジック（カード配布、交換、トリック、スコア計算）
- リアルタイムゲーム状態同期
- ゲーム永続化（データベース保存）
- 再接続・ハートビート機能
- 包括的エラーハンドリング
- 型安全なモック戦略（依存性注入パターン）
- フロントエンドビルド成功（Next.js）
- Next.js開発環境での安定したSocket.io通信✅ **修正完了**
- 複数プレイヤー参加時のReactコンポーネント表示✅ **修正完了**

## 凡例
- [ ] 未着手
- [x] 完了
- 🧪 テスト作成を含むタスク
- 📝 ドキュメント作成を含むタスク
- 🔧 設定・環境構築タスク

---

## Phase 1: 基盤構築 ✅ **完了**

### 1. プロジェクト初期化
- [x] 🔧 frontend/backendディレクトリ作成
- [ ] 🔧 ルートpackage.json作成（workspace設定）
- [x] 🔧 .gitignore更新（.env, node_modules, build等）
- [x] 🔧 .env.exampleファイル作成

### 2. Docker環境構築
- [x] 🔧 docker-compose.yml作成（PostgreSQL, frontend, backend）
- [x] 🔧 Dockerfile作成（frontend用）
- [x] 🔧 Dockerfile作成（backend用）
- [x] 🔧 .dockerignore作成
- [x] 🧪 Docker環境起動テスト

### 3. バックエンド初期設定
- [x] 🔧 backend/package.json作成
- [x] 🔧 backend/tsconfig.json設定
- [x] 🔧 ESLint設定（backend/.eslintrc.json）
- [x] 🔧 Prettier設定（.prettierrc）
- [x] 🔧 Jest設定（backend/jest.config.js）
- [x] 🔧 開発用設定（tsx使用）

### 4. フロントエンド初期設定
- [x] 🔧 Next.js 14プロジェクト作成（App Router）
- [x] 🔧 TypeScript厳密モード設定
- [x] 🔧 Tailwind CSS設定
- [x] 🔧 ESLint設定更新
- [x] 🔧 Jest + React Testing Library設定

---

## Phase 2: データベース層構築 ✅ **完了**

### 5. Prisma初期設定
- [x] 🔧 backend/prisma/schema.prisma作成
- [x] 🔧 DATABASE_URL環境変数設定
- [x] 🧪 Prisma接続テスト作成・実行

### 6. スキーマ定義（基本テーブル）
- [x] 📝 Playerモデル定義
- [x] 📝 Cardモデル定義
- [x] 📝 Gameモデル定義
- [x] 📝 Handモデル定義
- [x] 📝 Trickモデル定義

### 7. スキーマ定義（詳細テーブル）
- [x] 📝 HandCardモデル定義
- [x] 📝 CardExchangeモデル定義
- [x] 📝 TrickCardモデル定義
- [x] 📝 HandScoreモデル定義
- [x] 📝 GameSessionモデル定義

### 8. スキーマ定義（統計テーブル）
- [x] 📝 PlayerStatisticsモデル定義
- [x] 📝 MonthlyStatisticsモデル定義

### 9. データベース初期化
- [x] 🔧 初期マイグレーション実行（prisma db push）
- [x] 📝 seed.tsファイル作成
- [x] 📝 プレイヤーマスターデータ投入スクリプト
- [x] 📝 カードマスターデータ投入スクリプト（52枚、ポイント値含む）
- [x] 🧪 seedデータ投入テスト

---

## Phase 3: バックエンドAPI基盤 ✅ **完了**

### 10. Express基本設定
- [x] 🧪 server.tsのテスト作成
- [x] 📝 server.ts実装（Express起動）
- [x] 📝 CORS設定
- [x] 📝 エラーハンドリングミドルウェア
- [x] 📝 ロギング設定（morgan）

### 11. 基本APIエンドポイント
- [x] 🧪 GET /health テスト作成
- [x] 📝 GET /health 実装
- [x] 🧪 GET /api/players テスト作成
- [x] 📝 GET /api/players 実装
- [x] 📝 GET /api/info 実装

### 12. Prismaサービス層
- [x] 🧪 PrismaServiceテスト作成
- [x] 📝 PrismaService実装
- [x] 🧪 PlayerRepositoryテスト作成
- [x] 📝 PlayerRepository実装

---

## Phase 4: ゲームロジック実装 ✅ **完了**

### 13. カード関連ユーティリティ
- [x] 🧪 Card型定義テスト
- [x] 📝 Card型定義（game/Card.ts）
- [x] 🧪 デッキ生成関数テスト
- [x] 📝 デッキ生成関数実装
- [x] 🧪 シャッフル関数テスト
- [x] 📝 シャッフル関数実装

### 14. ゲームルールエンジン
- [x] 🧪 カード配布ロジックテスト
- [x] 📝 カード配布ロジック実装
- [x] 🧪 カード交換ルールテスト
- [x] 📝 カード交換ルール実装
- [x] 🧪 有効カード判定テスト
- [x] 📝 有効カード判定実装
- [x] 🧪 トリック勝者判定テスト
- [x] 📝 トリック勝者判定実装

### 15. スコア計算
- [x] 🧪 基本スコア計算テスト
- [x] 📝 基本スコア計算実装
- [x] 🧪 ハートブレイク判定テスト
- [x] 📝 ハートブレイク判定実装
- [x] 🧪 シュートザムーンテスト
- [x] 📝 シュートザムーン実装

### 16. ゲーム状態管理
- [x] 🧪 GameStateクラステスト
- [x] 📝 GameStateクラス実装
- [x] 🧪 状態遷移テスト
- [x] 📝 状態遷移実装
- [x] 🧪 ゲーム終了判定テスト
- [x] 📝 ゲーム終了判定実装

---

## Phase 5: Socket.io通信層 ✅ **完了**

### 17. Socket.io基本設定
- [x] 🔧 Socket.ioサーバー設定
- [x] 📝 接続イベントハンドラ
- [x] 📝 切断イベントハンドラ
- [x] 🧪 Socket.io接続テスト（基本）

### 18. GameServiceとSocket.io統合
- [x] 📝 GameService実装（シングルトンパターン）
- [x] 📝 SocketHandlers実装（型安全な通信）
- [x] 📝 プレイヤー参加処理（joinGame）
- [x] 📝 ゲーム状態管理とリアルタイム同期
- [x] 📝 自動ゲーム開始（4人揃った時）

### 19. ゲームイベント定義と実装
- [x] 📝 イベント型定義（backend/src/types, frontend/src/types）
- [x] 📝 loginイベント実装
- [x] 📝 joinGameイベント実装
- [x] 📝 playCardイベント実装
- [x] 📝 exchangeCardsイベント実装
- [x] 📝 リアルタイムゲーム進行イベント（gameStateChanged, cardPlayed, etc）

---

## Phase 6: バックエンドサービス層 ✅ **完了**

### 20. GameService機能強化
- [x] 📝 ゲーム永続化機能（データベース保存）
- [x] 📝 プレイヤー入力検証（アクティブ状態チェック）
- [x] 📝 エラーハンドリング改善
- [x] 📝 ゲーム結果保存機能
- [x] 🧪 GameServiceテスト実装（14テストケース）

### 21. SocketHandlers改善
- [x] 📝 接続状態管理（connected/disconnected/reconnected）
- [x] 📝 ハートビート機能による接続監視
- [x] 📝 再接続処理（30秒待機時間）
- [x] 📝 プレイヤー最終アクティブ時刻更新
- [x] 📝 詳細ログ出力
- [x] 🧪 SocketHandlersテスト実装（15テストケース）

### 22. Socket.io型定義拡張
- [x] 📝 ping/pongイベント追加
- [x] 📝 reconnectイベント追加
- [x] 📝 型安全な通信の確保
- [x] 🧪 型定義テスト（モック戦略）

### 23. モック戦略の再考と修正 ✅ **完了**
- [x] 🧪 PrismaServiceモック戦略の見直し（privateプロパティ問題）
- [x] 🧪 PlayerRepositoryモック戦略の見直し（コンストラクタ依存問題）
- [x] 📝 型安全なモック用ヘルパー関数実装
- [x] 🧪 players.test.tsの修正とテスト成功確認
- [x] 📝 モック戦略ガイドライン作成（将来のテスト用）

**実装完了:**
- 依存性注入パターン導入（Container.ts）
- IPlayerRepositoryインターフェース定義
- MockPlayerRepositoryヘルパー実装
- 全166個のテスト正常通過を確認
- モック戦略ガイドライン作成（docs/MOCK_STRATEGY_GUIDE.md）

**解決した技術的課題:**
1. DIコンテナによる依存性注入の導入
2. インターフェース分離によるモック対象の抽象化
3. 型安全なモックヘルパー関数の実装

---

## Phase 6.1: ゲーム復帰機能修正 ✅ **完了**

### 問題の詳細
ブラウザを閉じて再ログインした際に、進行中のゲームに復帰できず、プレイヤーが一人だけ新しいゲームを作成してしまう問題が発生。

### 根本原因（ログ分析結果）
- [x] 🔍 `GameService.joinGame()`メソッドの復帰ロジック不足を特定
- [x] 🔍 `playerGameMap`からの既存ゲーム情報取得が実装されていない
- [x] 🔍 常に`findAvailableGame() || createNewGame()`が実行される問題

### 55. ゲーム復帰ロジック実装 ✅ **完了**
- [x] 🧪 既存ゲーム復帰テスト作成
  - プレイヤーが既に参加しているゲームがある場合の復帰テスト
  - 進行中ゲーム（waiting、exchanging、playing フェーズ）での復帰テスト
  - 存在しないゲームIDでの安全な処理テスト
- [x] 📝 `GameService.joinGame()`メソッド修正
  - `playerGameMap.get(playerId)`による既存ゲーム確認ロジック追加
  - `gameEngines.has(existingGameId)`による有効性検証
  - 既存ゲーム復帰 vs 新規ゲーム参加の条件分岐実装
- [x] 📝 ゲーム状態復元機能実装
  - 復帰時の手札情報取得
  - 進行中フェーズに応じた適切な状態復元
  - Socket.ioマッピング更新（プレイヤー⇔ソケットID）

### 56. プレイヤー状態管理改善 ✅ **完了**
- [x] 📝 プレイヤー接続状態の正確な管理
  - `GamePlayer.isConnected`フラグの適切な更新
  - `lastActiveAt`タイムスタンプによる接続監視
  - 終了済みゲームからの自動クリーンアップ

### 57. エラーハンドリング強化 ✅ **完了**
- [x] 📝 復帰失敗時の適切なエラー処理
  - ゲームが既に終了している場合の処理
  - プレイヤーが存在しない場合の安全な処理
- [x] 📝 ログ出力改善
  - 復帰処理の詳細なログ追加
  - デバッグ用の状態情報出力強化
  - エラー原因の特定しやすいメッセージ実装

### 58. 統合テスト・動作確認 ✅ **完了**
- [x] 🧪 ゲーム復帰シナリオテスト作成（4つのテストケース追加）
  - 進行中ゲームへの復帰テスト
  - 終了済みゲームからの新規ゲーム参加テスト
  - プレイヤー不在時のエラーハンドリングテスト
  - 復帰時にゲーム自動開始が行われないことの確認テスト
- [x] 🧪 既存機能への影響確認
  - 全168個のバックエンドテスト正常通過
  - TypeScript型チェック・ESLint正常通過

**実装完了した修正ロジック:**
```typescript
public async joinGame(playerId: number): Promise<{ success: boolean; gameInfo?: GameInfo }> {
  console.log(`GameService.joinGame called for player ${playerId}`);
  
  let gameId: number;
  let isRejoining = false;
  
  // 1. まず既存のゲームを確認
  const existingGameId = this.playerGameMap.get(playerId);
  if (existingGameId && this.gameEngines.has(existingGameId)) {
    const existingEngine = this.gameEngines.get(existingGameId)!;
    const gameState = existingEngine.getGameState();
    
    // ゲームが終了していない場合のみ復帰
    if (gameState.status !== GameStatus.FINISHED) {
      console.log(`Player ${playerId} rejoining existing game ${existingGameId}`);
      gameId = existingGameId;
      isRejoining = true;
    } else {
      // 終了済みゲームの場合、マッピングをクリア
      console.log(`Player ${playerId} leaving completed game ${existingGameId}`);
      this.playerGameMap.delete(playerId);
      // クリーンアップ処理...
      gameId = this.findAvailableGame() || await this.createNewGame();
    }
  } else {
    // 2. 新規ゲーム参加
    gameId = this.findAvailableGame() || await this.createNewGame();
  }
  
  // 復帰時と新規参加時の処理分岐...
}
```

**技術的解決内容:**
1. **既存ゲーム確認**: `playerGameMap`による参加ゲーム情報取得実装
2. **ゲーム有効性検証**: `gameEngines.has()`と`GameStatus.FINISHED`チェック実装
3. **復帰 vs 新規判定**: 条件分岐による適切なルート選択実装
4. **状態復元**: プレイヤー接続状態の正確な更新実装
5. **テスト完備**: 4つの包括的なテストケースで品質保証
6. **既存機能保護**: 全168テスト正常通過で既存機能への影響なし確認

---

## Phase 7: フロントエンドゲーム画面 ✅ **完了**

### 24. 共通コンポーネント
- [x] 🧪 Cardコンポーネントテスト
- [x] 📝 Cardコンポーネント実装
- [x] 📝 ConnectionStatusコンポーネント実装
- [x] 📝 PlayerSelectコンポーネント実装
- [x] 📝 レイアウトコンポーネント（App Router）

### 25. Socket.ioクライアント
- [x] 📝 Socket接続フック作成（useSocket）
- [x] 📝 接続状態管理
- [x] 📝 エラーハンドリング（基本）
- [x] 📝 型安全なイベントリスナー管理

### 26. 状態管理
- [x] 📝 LoginState型定義
- [x] 📝 ConnectionState型定義
- [x] 📝 型定義（types/index.ts）
- [x] 📝 useGameフック実装（ゲーム状態管理）

### 27. ログイン画面
- [x] 📝 プレイヤー選択UI（4名固定）
- [x] 📝 接続処理（login関数）
- [x] 📝 エラー表示

### 28. 待機室画面
- [x] 📝 GameLobbyコンポーネント実装
- [x] 📝 ゲーム参加ボタン
- [x] 📝 プレイヤー情報表示

### 29. ゲーム画面基盤
- [x] 📝 GameBoardコンポーネント実装
- [x] 📝 Handコンポーネント実装（手札表示・操作）
- [x] 📝 プレイヤー配置とスコア表示
- [x] 📝 Socket.io統合とリアルタイム状態管理
- [x] 📝 フロントエンドビルド成功

---

## Phase 7.1: 通信問題修正 ✅ **完了**

### Socket.io通信問題解決
- [x] 🔧 Next.js開発環境での複数Socket接続問題分析
- [x] 📝 プレイヤー⇔ソケットIDマッピング機能実装
- [x] 📝 localStorage活用による状態永続化
- [x] 🧪 joinGameイベント型安全性向上
- [x] 📝 React 19とtesting-library依存関係修正
- [x] 🔧 開発環境Docker設定最適化

### 型定義統一・改善
- [x] 📝 joinGameイベントにプレイヤーIDパラメータ追加
- [x] 📝 フロントエンド・バックエンド型定義同期
- [x] 📝 GameInfo型定義追加とGameState変換処理
- [x] 🧪 型安全なSocket.io通信の確保

### 技術的解決内容
**解決した問題:**
1. Next.js Hot Reloadによる複数Socket接続問題
2. 異なるSocket間でのプレイヤー情報共有問題
3. "Failed to join game"エラーの根本原因
4. React 19環境での依存関係競合
5. 開発環境でのビルドエラー

**実装した解決策:**
1. グローバルなプレイヤー⇔ソケットIDマッピング
2. localStorage活用による状態永続化
3. 型安全なjoinGameイベント設計
4. 開発環境特化のDocker設定
5. 包括的なデバッグログ機能

---

## Phase 7.2: UI表示問題修正 ✅ **完了**

### Reactコンポーネントkey警告エラー解決
- [x] 🔧 複数プレイヤー参加時のReact key警告エラー分析
- [x] 📝 useGameフックでのプレイヤー参加処理改善
- [x] 📝 GameBoardコンポーネントでのプレイヤー表示修正
- [x] 🧪 プレイヤーIDのundefined問題解決
- [x] 📝 型安全なプレイヤー情報処理の実装

### 技術的解決内容
**解決した問題:**
1. 2人目プレイヤー参加時のReactコンポーネントkey警告エラー
2. バックエンドから数値で送られるプレイヤーIDの処理問題
3. undefinedプレイヤーIDによるmap処理エラー
4. 関数宣言の順序によるhoisting問題

**実装した解決策:**
1. プレイヤーIDがundefinedの場合のフィルタリング処理
2. 数値型プレイヤーIDのPlayerInfoオブジェクト変換
3. 適切なReactキープロパティの設定
4. 安全なプレイヤー情報表示処理

---

## Phase 8: ゲーム画面実装 ✅ **完了**

### 29. ゲームボード ✅ **完了**
- [x] 📝 ゲームボードレイアウト
- [x] 📝 プレイヤー配置（東西南北）
- [x] 📝 中央エリア（トリック表示）
- [x] 📝 スコア表示エリア

### 30. カード表示・操作（基本機能） ✅ **完了**
- [x] 📝 手札表示コンポーネント
- [x] 📝 手札配布イベントハンドリング
- [x] 📝 直感的カードソート（スート別、ランク順）
- [x] 📝 手札情報表示（枚数、スート分布）
- [x] 📝 モード別メッセージ表示

### 31. カード交換フェーズ（基本機能） ✅ **完了**
- [x] 🧪 カード交換UIテスト
- [x] 📝 3枚選択UI
- [x] 📝 交換確定ボタン
- [x] 📝 選択状態フィードバック

### 32. ゲーム進行表示（基本機能） ✅ **完了**
- [x] 📝 現在のトリック表示
- [x] 📝 ゲーム状態情報表示
- [x] 📝 ハートブレイク表示
- [x] 📝 手番インジケータ

**Phase 8実装完了:**
- 東西南北の直感的なプレイヤー配置
- 手札の直感的ソートと情報表示
- 4人揃った時の自動手札配布
- 改善されたゲーム状態表示
- 全30フロントエンドテスト正常動作

---

## Phase 9.1: 4人目プレイヤー手札配布問題修正 ✅ **完了**

### 手札配布タイミング問題解決
- [x] 🔧 Socket.ioの`sendToPlayer`メソッドタイミング問題分析
- [x] 📝 `setTimeout(callback, 0)`による次のイベントループでの送信実装
- [x] 🧪 Socket.ioハンドラーテスト修正（playerId引数、モックデータ追加）
- [x] 🧪 全166個のバックエンドテスト正常通過確認
- [x] 📝 4人揃った時の確実な手札配布動作確認

### 技術的解決内容
**解決した問題:**
1. 4人目のプレイヤーが参加時に手札が配布されない問題
2. GameEngineの`startGame()`とSocket.ioマッピングのタイミング競合
3. Socket.ioハンドラーテストでのコールバック関数エラー

**実装した解決策:**
1. `sendToPlayer`メソッドに非同期送信機能追加
2. プレイヤー参加完了後の確実なイベント送信保証
3. テストコード修正（playerId引数、プレイヤーデータモック）

**動作確認:**
- 4人全員が揃った時の自動手札配布が全プレイヤーに実行される
- Socket.ioハンドラーの15個のテスト全て正常通過
- バックエンド全体で166個のテスト正常通過

---

## Phase 9: カード操作UI詳細 ✅ **主要機能完了**

### 33. カード操作改善 ✅ **完了**
- [x] 📝 カード選択UI改善（アニメーション効果、選択プログレスバー、選択詳細表示）
- [x] 📝 有効カードハイライト（バックエンド連携、リアルタイム判定）
- [x] 📝 カードホバー効果（高度なアニメーション、ツールチップ、視覚的フィードバック）

### 34. カード交換フェーズ詳細 ✅ **完了**
- [x] 📝 交換方向表示（左隣・右隣・向かい・なし）
- [x] 📝 交換進捗表示（4人中何人完了、リアルタイム更新）
- [x] 📝 交換完了フィードバック（完了メッセージ、待機表示）

**Phase 9実装完了:**
- 有効カードハイライト機能（Socket.io通信による動的判定）
- 高度なカードホバー効果とツールチップ機能
- 直感的なカード選択UI（アニメーション、プログレス表示）
- カード交換フェーズUI完全実装（方向表示、進捗表示、完了フィードバック）
- 全バックエンドテスト171個、全フロントエンドテスト30個正常動作

---

## Phase 10: ゲーム進行機能 ✅ **完了**

### 36. 実際のゲーム進行
- [x] 📝 カードプレイ処理（リアルタイム手札更新、状態同期強化）
- [x] 📝 トリック勝者判定（GameStateで実装済み）
- [x] 📝 スコア計算と表示（シュートザムーン対応）
- [x] 📝 ハンド終了処理（GameEngineで実装済み）
- [x] 📝 ゲーム終了判定（100点到達時）

### 37. ゲームフロー（UI改善）
- [x] 📝 カードプレイアニメーション（fadeInUp、cardPlayエフェクト）
- [x] 📝 トリック表示改善（カード詳細表示、進捗表示）
- [x] 📝 手札更新イベント（Socket.io handUpdated）
- [x] 📝 型定義拡張（GameStateUpdate型追加）

**Phase 10実装完了:**
- カードプレイ処理のリアルタイム同期強化
- トリック表示の詳細化とアニメーション追加
- 手札更新イベントによる即座な状態反映
- 全171バックエンドテスト、全30フロントエンドテスト正常動作
- lint/type-checkエラーなし

---

## Phase 10.1: ゲーム終了点数設定機能 ✅ **完了**

### ゲーム終了点数の環境変数設定
- [x] 🔧 `.env`ファイルに`GAME_END_SCORE=30`追加（デバッグ用設定）
- [x] 📝 `src/config/gameConfig.ts`実装（環境変数読み込み機能）
- [x] 📝 `GameState.isGameCompleted()`修正（設定可能な終了点数使用）
- [x] 🧪 テストファイルでgameConfigモック化（既存テスト維持）
- [x] 🧪 全166個のバックエンドテスト正常通過確認

**実装完了:**
- 環境変数`GAME_END_SCORE`による終了点数設定
- デフォルト値100点、デバッグ時30点の切り替え可能
- 設定値検証機能（正の数のみ受け入れ）
- 既存テストの完全互換性維持

**技術的詳細:**
1. 設定ファイル: `backend/src/config/gameConfig.ts`
2. 環境変数: `GAME_END_SCORE=30` (backend/.env)
3. 対象メソッド: `GameState.isGameCompleted()`
4. テスト対応: Jest mock機能でテスト環境維持

---

## バグ修正: クラブの2強制プレイルール ✅ **完了**

### 問題の詳細
2ハンド目以降、最初のトリックでクラブの2を持つプレイヤーがクラブの2以外のカードを出せてしまう問題が発生。

### 根本原因
- [x] 🔍 `GameState.canPlayCard()`メソッドの条件判定問題を特定
- [x] 🔍 クラブの2強制ルールが`this.currentHand === 1`条件で1ハンド目にのみ適用
- [x] 🔍 ハーツゲームルールでは毎ハンドの最初のトリックでクラブの2強制が必要

### 修正内容
- [x] 🔧 `GameState.ts:293`の条件判定を`if (this.currentTrick === 1)`に修正
- [x] 🧪 2ハンド目および3ハンド目のテストケース追加
- [x] ✅ 修正後、全168個のテストが正常通過を確認

**修正ファイル:**
1. `backend/src/game/GameState.ts` - canPlayCard()メソッド修正
2. `backend/src/__tests__/game/GameState.test.ts` - テストケース追加

**修正前:**
```typescript
if (this.currentTrick === 1 && this.currentHand === 1) {
  const hasClubTwo = player.hand.some(c => c.isTwoOfClubs());
  if (hasClubTwo && !card.isTwoOfClubs()) return false;
}
```

**修正後:**
```typescript
if (this.currentTrick === 1) {
  const hasClubTwo = player.hand.some(c => c.isTwoOfClubs());
  if (hasClubTwo && !card.isTwoOfClubs()) return false;
}
```

---

## Phase 11: データ永続化詳細

### 33. ゲーム保存処理
- [ ] 🧪 ゲーム作成APIテスト
- [ ] 📝 ゲーム作成API実装
- [ ] 🧪 ハンド保存テスト
- [ ] 📝 ハンド保存実装
- [ ] 🧪 トリック保存テスト
- [ ] 📝 トリック保存実装

### 34. リアルタイム同期
- [ ] 📝 状態変更→DB保存
- [ ] 📝 DB保存→クライアント通知
- [ ] 🧪 同期テスト

---

## Phase 10: 利便性向上機能

### 35. スコアグラフ
- [ ] 🔧 Chart.js設定
- [ ] 🧪 ScoreGraphコンポーネントテスト
- [ ] 📝 ScoreGraphコンポーネント実装
- [ ] 📝 リアルタイム更新処理
- [ ] 📝 グラフオプション調整

### 36. 切断・再接続
- [x] 🧪 セッション管理テスト
- [x] 📝 セッション保存処理
- [x] 📝 再接続ハンドラ
- [x] 📝 状態復元処理
- [ ] 📝 再接続UI表示

### 37. エラーハンドリング
- [x] 📝 グローバルエラーハンドラ
- [ ] 📝 エラー通知コンポーネント
- [ ] 📝 リトライ処理
- [ ] 📝 エラーログ送信

---

## Phase 11: 体験向上機能

### 38. ゲーム履歴API
- [ ] 🧪 GET /api/games テスト
- [ ] 📝 GET /api/games 実装（一覧）
- [ ] 🧪 GET /api/games/:id テスト
- [ ] 📝 GET /api/games/:id 実装（詳細）

### 39. 履歴画面
- [ ] 📝 ゲーム一覧画面
- [ ] 📝 ゲーム詳細画面
- [ ] 📝 ハンド詳細表示
- [ ] 📝 リプレイ機能（読み取り専用）

### 40. 統計機能
- [ ] 🧪 統計計算テスト
- [ ] 📝 統計計算バッチ
- [ ] 📝 統計API実装
- [ ] 📝 統計ダッシュボード

### 41. UI/UX改善
- [ ] 📝 カードアニメーション改善
- [ ] 📝 効果音追加
- [ ] 📝 ツールチップ追加
- [ ] 📝 キーボードショートカット

---

## Phase 12: 品質向上

### 42. パフォーマンス最適化
- [ ] 📝 データベースインデックス追加
- [ ] 📝 クエリ最適化
- [ ] 📝 フロントエンド最適化
- [ ] 🧪 負荷テスト

### 43. セキュリティ
- [ ] 📝 入力値検証強化
- [ ] 📝 レート制限実装
- [ ] 🧪 セキュリティテスト

### 44. 運用準備
- [ ] 📝 環境変数ドキュメント
- [ ] 📝 デプロイ手順書
- [ ] 📝 監視設定
- [ ] 📝 バックアップ設定

---

## Phase 13: 低優先度機能改善

### 45. カードアニメーション（低優先度）
- [ ] 📝 カードプレイアニメーション
- [ ] 📝 交換アニメーション
- [ ] 📝 獲得カード表示
- [ ] 📝 トリック勝者表示
- [ ] 📝 スコア変動アニメーション
- [ ] 📝 フェーズ遷移アニメーション

### 46. 席順ランダム化（常時有効）
**仕様**: 席順ランダム化機能は常に有効とし、通常の席順との切り替えは不要。席順はゲーム参加時にランダムに割り振られ、ハンドが変わっても席順は変わりません。

- [ ] 📝 ランダム席順ロジック実装（バックエンド）
  - GameServiceでのプレイヤー参加時席順ランダム割り当て
  - 4人揃った時点での席順決定とゲーム全体固定
  - 既存のPosition型（North, East, South, West）活用
- [ ] 🧪 ランダム席順テスト作成
  - 4人参加時の席順ランダム性テスト
  - 同じプレイヤーIDでも毎回異なる席順確認
  - ハンド変更時の席順維持テスト
- [ ] 📝 フロントエンド席順表示更新
  - GameBoardコンポーネントでの動的席順表示
  - プレイヤー情報の席順に応じた配置更新
  - 既存UI/UXとの整合性維持

### 47. 手札ソート順変更 ✅ **完了**
- [x] 📝 スートソート順変更（クラブ→ダイヤ→スペード→ハート）
- [x] 🧪 新しいソート順テスト
- [x] 📝 フロントエンド手札表示更新
- [x] 🧪 既存の手札テスト修正

### 48. カード絵柄画像化 ✅ **完了**
- [x] 📝 カード画像ファイル準備（52枚）-> frontend/public/cards 以下にある
- [x] 📝 画像ローディング機能実装
- [x] 📝 Cardコンポーネント画像表示対応
- [x] 📝 画像最適化とキャッシュ設定
- [x] 🧪 画像表示テスト

### 49. ログイン簡素化 ✅ **完了**
- [x] 📝 プレイヤー選択→直接ゲーム参加フロー実装
- [x] 📝 ロビー画面のスキップロジック
- [x] 📝 自動ゲーム参加処理
- [x] 🧪 新しいログインフローテスト
- [x] 📝 既存UI/UXとの整合性確保

### 50. ゲーム参加中画面からの進行問題修正 ✅ **完了**
- [x] 🔍 4人揃った時のゲーム進行問題調査（React状態更新タイミング問題を特定）
- [x] 📝 自動参加処理の修正（useEffectによる状態監視方式に変更）
- [x] 📝 useGameフックのisInGameフラグ設定修正（handStarted、cardsDealtイベントで設定）
- [x] 🧪 全47テスト正常通過確認
- [x] 📝 TypeScript型チェック・ESLint正常確認

---

## Phase 14: 追加UI改善要求（additional_requirements.md対応）

### 50. 現在ハンド点数表示機能 ✅ **完了**
- [x] 📝 プレイエリアでの現在ハンド点数表示UI設計
- [x] 📝 各プレイヤーのユーザー名下点数表示コンポーネント実装
- [x] 📝 トリック完了時のリアルタイム点数更新処理
- [x] 📝 ハンド内累積点数とゲーム累計点数の区別表示
- [x] 🧪 点数表示機能テスト作成
- [x] 📝 Socket.ioイベント（handScoreUpdate）実装
- [x] 📝 GameStateでの現在ハンド点数管理機能

### 51. 手番制御による操作制限UI ✅ **完了**
- [x] 📝 手番でない時のカード選択不可状態実装
- [x] 📝 カード全体のグレーアウト表示機能
- [x] 📝 手番プレイヤーのハイライト表示強化
- [x] 📝 手番インジケータの視覚的改善
- [x] 🧪 手番制御UIテスト作成
- [x] 📝 Hand コンポーネントでの操作制限実装
- [x] 📝 現在の手番プレイヤー判定ロジック改良

### 52. カード回収ウェイト機能
- [ ] 📝 全プレイヤーカードプレイ完了検知機能
- [ ] 📝 2秒間の視認用待機時間実装
- [ ] 📝 待機中の進行状況表示UI
- [ ] 📝 カード回収タイミング制御機能
- [ ] 🧪 ウェイト機能テスト作成
- [ ] 📝 GameEngineでのトリック完了処理改良
- [ ] 📝 Socket.ioでの待機状態同期

### 53. トリック勝者カードアニメーション
- [ ] 📝 カードの勝者プレイヤーへの移動アニメーション実装
- [ ] 📝 CSS/JSアニメーションライブラリ選定と設定
- [ ] 📝 勝者の視覚的強調表示（ハイライト、エフェクト）
- [ ] 📝 アニメーション完了後のカード回収処理
- [ ] 🧪 アニメーション機能テスト作成
- [ ] 📝 トリック勝者判定とアニメーション連携
- [ ] 📝 Cardコンポーネントでのアニメーション対応

### 54. 統合テスト・品質確保
- [ ] 🧪 Phase 14全機能の統合テスト
- [ ] 📝 既存機能との整合性確認
- [ ] 📝 パフォーマンス影響評価
- [ ] 📝 アクセシビリティ対応確認
- [ ] 🧪 E2Eテストでの動作確認

### 55. カードグレイアウト状態でのスーツ色判別改善 ✅ **完了**
**問題の詳細**: 現在、isPlayable=falseの時にgrayscaleフィルターが適用され、ハート・ダイヤの赤色とクラブ・スペードの黒色が判別できない状態になっている。

**解決方針**: スーツの色判別を可能にしながら、選択不可状態を視覚的に表現する改善実装

- [x] 📝 現在のgrayscaleクラス削除実装
- [x] 📝 代替視覚表現の実装（opacity、brightness、contrast調整）
  - `opacity-60` + `brightness-75` + `contrast-75`による無効化表現
- [x] 📝 スーツ色を維持したまま選択不可状態の明確な表現
- [x] 🧪 新しい無効化表現のテスト実装
- [x] 📝 frontend/src/components/game/Card.tsx修正
  - getCardClasses()メソッドの!isPlayable条件分岐修正
  - grayscaleクラス削除、代替スタイリング適用
- [x] 🧪 カード表示テストケース更新（Card.test.tsx、Hand.test.tsx）
- [x] 📝 UI/UX一貫性確認（全60フロントエンドテスト正常通過）

**実装完了スタイル**:
```typescript
// 修正前: 'opacity-50', 'grayscale' 
// 修正後: 'opacity-60', 'brightness-75', 'contrast-75'
```

**技術的成果**:
- スーツの色判別機能復活（ハート・ダイヤの赤色、クラブ・スペードの黒色）
- プレイ不可能カードの視覚的フィードバック維持
- 全60フロントエンドテスト正常通過
- TypeScript型チェック・ESLint正常通過

### 56. 他プレイヤー手番待ち時のカード表示改善 ✅ **完了**
**問題の詳細**: 他のプレイヤーの手番待ち状態で、手札全体にグレイアウト処理が適用されているが、55.と同様にスーツの色判別ができない状態になっている。

**解決方針**: 手番待ち状態でも55.と同じ視覚表現を適用し、スーツの色判別を可能にする

- [x] 📝 他プレイヤー手番時の手札表示状態調査
  - Hand.tsx の`isDisabledByTurn`条件での`filter grayscale`適用を特定
  - 195行目の`opacity-50 cursor-not-allowed filter grayscale`スタイルが原因
- [x] 📝 現在の手番判定ロジック確認（Hand.tsx、GameBoard.tsx）
  - `isPlayerTurn={currentTurn === currentPlayerId}`で手番状態管理
  - `mode === 'play' && !isPlayerTurn`の条件でgrayscale適用
- [x] 📝 55.と同じ代替視覚表現の適用
  - `opacity-60` + `brightness-75` + `contrast-75`による待機表現
  - grayscaleフィルター削除
- [x] 📝 手番待ち状態での操作無効化処理確認
  - `pointer-events-none`と`cursor-not-allowed`で操作無効化維持
  - isPlayableプロパティも適切に`false`設定
- [x] 🧪 手番待ち状態のテストケース作成・更新
  - 既存テスト（Hand.test.tsx 194-205行目）は影響なし確認
- [x] 📝 UI/UX一貫性確認（isPlayable=falseと手番待ち状態の統一）
  - isPlayable=false時とisDisabledByTurn時で同じ視覚効果に統一
- [x] 🧪 既存テスト正常通過確認
  - 全60フロントエンドテスト正常通過
  - TypeScript型チェック・ESLint正常通過

**実装完了した修正:**
```typescript
// 修正前（Hand.tsx 195行目）：
? 'opacity-50 cursor-not-allowed filter grayscale'

// 修正後：
? 'opacity-60 cursor-not-allowed brightness-75 contrast-75'
```

**技術的成果:**
- 手番待ち状態でもスーツの色判別が可能（ハート・ダイヤの赤色、クラブ・スペードの黒色）
- 55.のisPlayable=false時の視覚表現と統一
- 操作無効化処理は維持（pointer-events-none、cursor-not-allowed）
- 全60フロントエンドテスト正常通過
- UI/UX一貫性の向上

---

## 完了基準
- すべてのテストがパスすること
- ESLint/TypeScriptエラーがないこと
- ドキュメントが最新であること
- コードレビューが完了していること