# Manta 開発TODO

このドキュメントは、Mantaプロジェクトの詳細な開発タスクリストです。
各タスクは完了時にチェックし、git commitを行います。

## 🎯 現在の進捗状況（2025/05/31更新）

### ✅ 完了したPhase
- **Phase 1: 基盤構築** - Docker環境、TypeScript設定、プロジェクト構造、Prettier・Jest設定完了
- **Phase 2: データベース層構築** - Prismaスキーマ、シードデータ、52枚カード定義
- **Phase 3: バックエンドAPI基盤** - Express + Socket.io、エラーハンドリング、ロギング、Players API、PrismaService、Repository層
- **Phase 4: ゲームロジック実装** - Card、Deck、Player、GameState、GameEngine（120個のテスト全て合格）
- **Phase 5: Socket.io通信層** - GameServiceとSocket.ioハンドラー統合、リアルタイム通信
- **Phase 6: バックエンドサービス層** - ゲーム永続化、モック戦略改善、依存性注入パターン（166個のテスト全て合格）
- **Phase 7: フロントエンドゲーム画面** - ゲームボード、カード操作UI、リアルタイム表示、Socket.io統合
- **Phase 7.1: 通信問題修正** - Socket.io複数接続問題解決、joinGame機能修正、型安全性向上
- **Phase 7.2: UI表示問題修正** - Reactコンポーネントkey警告エラー解決、プレイヤー情報表示改善

### 🚧 進行中のPhase  
- **Phase 8: ゲーム画面実装** - ゲームボード詳細機能、カードアニメーション、交換フェーズ

### 📋 次の重点実装領域
- **Phase 8: ゲーム画面実装** - ゲームボード詳細機能、カードアニメーション、交換フェーズ

### 🎮 動作確認可能な機能
- http://localhost:3000 でプレイヤー選択画面表示
- Socket.io接続状態のリアルタイム表示
- 4名固定プレイヤーでのログイン機能
- ゲームロビー画面（ゲーム参加機能）✅ **修正完了**
- ゲームボード画面（手札表示、プレイヤー情報、スコア表示）
- カードコンポーネント（スート、ランク、ポイント表示）
- 手札コンポーネント（カード選択、交換機能）
- データベース（PostgreSQL）との接続・データ投入
- 完全なゲームロジック（カード配布、交換、トリック、スコア計算）
- リアルタイムゲーム状態同期
- ゲーム永続化（データベース保存）
- 再接続・ハートビート機能
- 包括的エラーハンドリング
- 型安全なモック戦略（依存性注入パターン）
- フロントエンドビルド成功（Next.js）
- Next.js開発環境での安定したSocket.io通信✅ **修正完了**
- 複数プレイヤー参加時のReactコンポーネント表示✅ **修正完了**

## 凡例
- [ ] 未着手
- [x] 完了
- 🧪 テスト作成を含むタスク
- 📝 ドキュメント作成を含むタスク
- 🔧 設定・環境構築タスク

---

## Phase 1: 基盤構築 ✅ **完了**

### 1. プロジェクト初期化
- [x] 🔧 frontend/backendディレクトリ作成
- [ ] 🔧 ルートpackage.json作成（workspace設定）
- [x] 🔧 .gitignore更新（.env, node_modules, build等）
- [x] 🔧 .env.exampleファイル作成

### 2. Docker環境構築
- [x] 🔧 docker-compose.yml作成（PostgreSQL, frontend, backend）
- [x] 🔧 Dockerfile作成（frontend用）
- [x] 🔧 Dockerfile作成（backend用）
- [x] 🔧 .dockerignore作成
- [x] 🧪 Docker環境起動テスト

### 3. バックエンド初期設定
- [x] 🔧 backend/package.json作成
- [x] 🔧 backend/tsconfig.json設定
- [x] 🔧 ESLint設定（backend/.eslintrc.json）
- [x] 🔧 Prettier設定（.prettierrc）
- [x] 🔧 Jest設定（backend/jest.config.js）
- [x] 🔧 開発用設定（tsx使用）

### 4. フロントエンド初期設定
- [x] 🔧 Next.js 14プロジェクト作成（App Router）
- [x] 🔧 TypeScript厳密モード設定
- [x] 🔧 Tailwind CSS設定
- [x] 🔧 ESLint設定更新
- [x] 🔧 Jest + React Testing Library設定

---

## Phase 2: データベース層構築 ✅ **完了**

### 5. Prisma初期設定
- [x] 🔧 backend/prisma/schema.prisma作成
- [x] 🔧 DATABASE_URL環境変数設定
- [x] 🧪 Prisma接続テスト作成・実行

### 6. スキーマ定義（基本テーブル）
- [x] 📝 Playerモデル定義
- [x] 📝 Cardモデル定義
- [x] 📝 Gameモデル定義
- [x] 📝 Handモデル定義
- [x] 📝 Trickモデル定義

### 7. スキーマ定義（詳細テーブル）
- [x] 📝 HandCardモデル定義
- [x] 📝 CardExchangeモデル定義
- [x] 📝 TrickCardモデル定義
- [x] 📝 HandScoreモデル定義
- [x] 📝 GameSessionモデル定義

### 8. スキーマ定義（統計テーブル）
- [x] 📝 PlayerStatisticsモデル定義
- [x] 📝 MonthlyStatisticsモデル定義

### 9. データベース初期化
- [x] 🔧 初期マイグレーション実行（prisma db push）
- [x] 📝 seed.tsファイル作成
- [x] 📝 プレイヤーマスターデータ投入スクリプト
- [x] 📝 カードマスターデータ投入スクリプト（52枚、ポイント値含む）
- [x] 🧪 seedデータ投入テスト

---

## Phase 3: バックエンドAPI基盤 ✅ **完了**

### 10. Express基本設定
- [x] 🧪 server.tsのテスト作成
- [x] 📝 server.ts実装（Express起動）
- [x] 📝 CORS設定
- [x] 📝 エラーハンドリングミドルウェア
- [x] 📝 ロギング設定（morgan）

### 11. 基本APIエンドポイント
- [x] 🧪 GET /health テスト作成
- [x] 📝 GET /health 実装
- [x] 🧪 GET /api/players テスト作成
- [x] 📝 GET /api/players 実装
- [x] 📝 GET /api/info 実装

### 12. Prismaサービス層
- [x] 🧪 PrismaServiceテスト作成
- [x] 📝 PrismaService実装
- [x] 🧪 PlayerRepositoryテスト作成
- [x] 📝 PlayerRepository実装

---

## Phase 4: ゲームロジック実装 ✅ **完了**

### 13. カード関連ユーティリティ
- [x] 🧪 Card型定義テスト
- [x] 📝 Card型定義（game/Card.ts）
- [x] 🧪 デッキ生成関数テスト
- [x] 📝 デッキ生成関数実装
- [x] 🧪 シャッフル関数テスト
- [x] 📝 シャッフル関数実装

### 14. ゲームルールエンジン
- [x] 🧪 カード配布ロジックテスト
- [x] 📝 カード配布ロジック実装
- [x] 🧪 カード交換ルールテスト
- [x] 📝 カード交換ルール実装
- [x] 🧪 有効カード判定テスト
- [x] 📝 有効カード判定実装
- [x] 🧪 トリック勝者判定テスト
- [x] 📝 トリック勝者判定実装

### 15. スコア計算
- [x] 🧪 基本スコア計算テスト
- [x] 📝 基本スコア計算実装
- [x] 🧪 ハートブレイク判定テスト
- [x] 📝 ハートブレイク判定実装
- [x] 🧪 シュートザムーンテスト
- [x] 📝 シュートザムーン実装

### 16. ゲーム状態管理
- [x] 🧪 GameStateクラステスト
- [x] 📝 GameStateクラス実装
- [x] 🧪 状態遷移テスト
- [x] 📝 状態遷移実装
- [x] 🧪 ゲーム終了判定テスト
- [x] 📝 ゲーム終了判定実装

---

## Phase 5: Socket.io通信層 ✅ **完了**

### 17. Socket.io基本設定
- [x] 🔧 Socket.ioサーバー設定
- [x] 📝 接続イベントハンドラ
- [x] 📝 切断イベントハンドラ
- [x] 🧪 Socket.io接続テスト（基本）

### 18. GameServiceとSocket.io統合
- [x] 📝 GameService実装（シングルトンパターン）
- [x] 📝 SocketHandlers実装（型安全な通信）
- [x] 📝 プレイヤー参加処理（joinGame）
- [x] 📝 ゲーム状態管理とリアルタイム同期
- [x] 📝 自動ゲーム開始（4人揃った時）

### 19. ゲームイベント定義と実装
- [x] 📝 イベント型定義（backend/src/types, frontend/src/types）
- [x] 📝 loginイベント実装
- [x] 📝 joinGameイベント実装
- [x] 📝 playCardイベント実装
- [x] 📝 exchangeCardsイベント実装
- [x] 📝 リアルタイムゲーム進行イベント（gameStateChanged, cardPlayed, etc）

---

## Phase 6: バックエンドサービス層 ✅ **完了**

### 20. GameService機能強化
- [x] 📝 ゲーム永続化機能（データベース保存）
- [x] 📝 プレイヤー入力検証（アクティブ状態チェック）
- [x] 📝 エラーハンドリング改善
- [x] 📝 ゲーム結果保存機能
- [x] 🧪 GameServiceテスト実装（14テストケース）

### 21. SocketHandlers改善
- [x] 📝 接続状態管理（connected/disconnected/reconnected）
- [x] 📝 ハートビート機能による接続監視
- [x] 📝 再接続処理（30秒待機時間）
- [x] 📝 プレイヤー最終アクティブ時刻更新
- [x] 📝 詳細ログ出力
- [x] 🧪 SocketHandlersテスト実装（15テストケース）

### 22. Socket.io型定義拡張
- [x] 📝 ping/pongイベント追加
- [x] 📝 reconnectイベント追加
- [x] 📝 型安全な通信の確保
- [x] 🧪 型定義テスト（モック戦略）

### 23. モック戦略の再考と修正 ✅ **完了**
- [x] 🧪 PrismaServiceモック戦略の見直し（privateプロパティ問題）
- [x] 🧪 PlayerRepositoryモック戦略の見直し（コンストラクタ依存問題）
- [x] 📝 型安全なモック用ヘルパー関数実装
- [x] 🧪 players.test.tsの修正とテスト成功確認
- [x] 📝 モック戦略ガイドライン作成（将来のテスト用）

**実装完了:**
- 依存性注入パターン導入（Container.ts）
- IPlayerRepositoryインターフェース定義
- MockPlayerRepositoryヘルパー実装
- 全166個のテスト正常通過を確認
- モック戦略ガイドライン作成（docs/MOCK_STRATEGY_GUIDE.md）

**解決した技術的課題:**
1. DIコンテナによる依存性注入の導入
2. インターフェース分離によるモック対象の抽象化
3. 型安全なモックヘルパー関数の実装

---

## Phase 7: フロントエンドゲーム画面 ✅ **完了**

### 24. 共通コンポーネント
- [x] 🧪 Cardコンポーネントテスト
- [x] 📝 Cardコンポーネント実装
- [x] 📝 ConnectionStatusコンポーネント実装
- [x] 📝 PlayerSelectコンポーネント実装
- [x] 📝 レイアウトコンポーネント（App Router）

### 25. Socket.ioクライアント
- [x] 📝 Socket接続フック作成（useSocket）
- [x] 📝 接続状態管理
- [x] 📝 エラーハンドリング（基本）
- [x] 📝 型安全なイベントリスナー管理

### 26. 状態管理
- [x] 📝 LoginState型定義
- [x] 📝 ConnectionState型定義
- [x] 📝 型定義（types/index.ts）
- [x] 📝 useGameフック実装（ゲーム状態管理）

### 27. ログイン画面
- [x] 📝 プレイヤー選択UI（4名固定）
- [x] 📝 接続処理（login関数）
- [x] 📝 エラー表示

### 28. 待機室画面
- [x] 📝 GameLobbyコンポーネント実装
- [x] 📝 ゲーム参加ボタン
- [x] 📝 プレイヤー情報表示

### 29. ゲーム画面基盤
- [x] 📝 GameBoardコンポーネント実装
- [x] 📝 Handコンポーネント実装（手札表示・操作）
- [x] 📝 プレイヤー配置とスコア表示
- [x] 📝 Socket.io統合とリアルタイム状態管理
- [x] 📝 フロントエンドビルド成功

---

## Phase 7.1: 通信問題修正 ✅ **完了**

### Socket.io通信問題解決
- [x] 🔧 Next.js開発環境での複数Socket接続問題分析
- [x] 📝 プレイヤー⇔ソケットIDマッピング機能実装
- [x] 📝 localStorage活用による状態永続化
- [x] 🧪 joinGameイベント型安全性向上
- [x] 📝 React 19とtesting-library依存関係修正
- [x] 🔧 開発環境Docker設定最適化

### 型定義統一・改善
- [x] 📝 joinGameイベントにプレイヤーIDパラメータ追加
- [x] 📝 フロントエンド・バックエンド型定義同期
- [x] 📝 GameInfo型定義追加とGameState変換処理
- [x] 🧪 型安全なSocket.io通信の確保

### 技術的解決内容
**解決した問題:**
1. Next.js Hot Reloadによる複数Socket接続問題
2. 異なるSocket間でのプレイヤー情報共有問題
3. "Failed to join game"エラーの根本原因
4. React 19環境での依存関係競合
5. 開発環境でのビルドエラー

**実装した解決策:**
1. グローバルなプレイヤー⇔ソケットIDマッピング
2. localStorage活用による状態永続化
3. 型安全なjoinGameイベント設計
4. 開発環境特化のDocker設定
5. 包括的なデバッグログ機能

---

## Phase 7.2: UI表示問題修正 ✅ **完了**

### Reactコンポーネントkey警告エラー解決
- [x] 🔧 複数プレイヤー参加時のReact key警告エラー分析
- [x] 📝 useGameフックでのプレイヤー参加処理改善
- [x] 📝 GameBoardコンポーネントでのプレイヤー表示修正
- [x] 🧪 プレイヤーIDのundefined問題解決
- [x] 📝 型安全なプレイヤー情報処理の実装

### 技術的解決内容
**解決した問題:**
1. 2人目プレイヤー参加時のReactコンポーネントkey警告エラー
2. バックエンドから数値で送られるプレイヤーIDの処理問題
3. undefinedプレイヤーIDによるmap処理エラー
4. 関数宣言の順序によるhoisting問題

**実装した解決策:**
1. プレイヤーIDがundefinedの場合のフィルタリング処理
2. 数値型プレイヤーIDのPlayerInfoオブジェクト変換
3. 適切なReactキープロパティの設定
4. 安全なプレイヤー情報表示処理

---

## Phase 8: ゲーム画面実装

### 29. ゲームボード
- [ ] 📝 ゲームボードレイアウト
- [ ] 📝 プレイヤー配置（東西南北）
- [ ] 📝 中央エリア（トリック表示）
- [ ] 📝 スコア表示エリア

### 30. カード表示・操作
- [ ] 📝 手札表示コンポーネント
- [ ] 📝 カード選択UI
- [ ] 📝 カードプレイアニメーション
- [ ] 📝 有効カードハイライト

### 31. カード交換フェーズ
- [ ] 🧪 カード交換UIテスト
- [ ] 📝 3枚選択UI
- [ ] 📝 交換確定ボタン
- [ ] 📝 交換アニメーション

### 32. ゲーム進行表示
- [ ] 📝 現在のトリック表示
- [ ] 📝 獲得カード表示
- [ ] 📝 ハートブレイク表示
- [ ] 📝 手番インジケータ

---

## Phase 9: データ永続化詳細

### 33. ゲーム保存処理
- [ ] 🧪 ゲーム作成APIテスト
- [ ] 📝 ゲーム作成API実装
- [ ] 🧪 ハンド保存テスト
- [ ] 📝 ハンド保存実装
- [ ] 🧪 トリック保存テスト
- [ ] 📝 トリック保存実装

### 34. リアルタイム同期
- [ ] 📝 状態変更→DB保存
- [ ] 📝 DB保存→クライアント通知
- [ ] 🧪 同期テスト

---

## Phase 10: 利便性向上機能

### 35. スコアグラフ
- [ ] 🔧 Chart.js設定
- [ ] 🧪 ScoreGraphコンポーネントテスト
- [ ] 📝 ScoreGraphコンポーネント実装
- [ ] 📝 リアルタイム更新処理
- [ ] 📝 グラフオプション調整

### 36. 切断・再接続
- [x] 🧪 セッション管理テスト
- [x] 📝 セッション保存処理
- [x] 📝 再接続ハンドラ
- [x] 📝 状態復元処理
- [ ] 📝 再接続UI表示

### 37. エラーハンドリング
- [x] 📝 グローバルエラーハンドラ
- [ ] 📝 エラー通知コンポーネント
- [ ] 📝 リトライ処理
- [ ] 📝 エラーログ送信

---

## Phase 11: 体験向上機能

### 38. ゲーム履歴API
- [ ] 🧪 GET /api/games テスト
- [ ] 📝 GET /api/games 実装（一覧）
- [ ] 🧪 GET /api/games/:id テスト
- [ ] 📝 GET /api/games/:id 実装（詳細）

### 39. 履歴画面
- [ ] 📝 ゲーム一覧画面
- [ ] 📝 ゲーム詳細画面
- [ ] 📝 ハンド詳細表示
- [ ] 📝 リプレイ機能（読み取り専用）

### 40. 統計機能
- [ ] 🧪 統計計算テスト
- [ ] 📝 統計計算バッチ
- [ ] 📝 統計API実装
- [ ] 📝 統計ダッシュボード

### 41. UI/UX改善
- [ ] 📝 カードアニメーション改善
- [ ] 📝 効果音追加
- [ ] 📝 ツールチップ追加
- [ ] 📝 キーボードショートカット

---

## Phase 12: 品質向上

### 42. パフォーマンス最適化
- [ ] 📝 データベースインデックス追加
- [ ] 📝 クエリ最適化
- [ ] 📝 フロントエンド最適化
- [ ] 🧪 負荷テスト

### 43. セキュリティ
- [ ] 📝 入力値検証強化
- [ ] 📝 レート制限実装
- [ ] 🧪 セキュリティテスト

### 44. 運用準備
- [ ] 📝 環境変数ドキュメント
- [ ] 📝 デプロイ手順書
- [ ] 📝 監視設定
- [ ] 📝 バックアップ設定

---

## 完了基準
- すべてのテストがパスすること
- ESLint/TypeScriptエラーがないこと
- ドキュメントが最新であること
- コードレビューが完了していること