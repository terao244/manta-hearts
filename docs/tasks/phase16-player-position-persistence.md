# Phase 16: プレイヤー席順のデータベース永続化実装

## 概要

プレイヤーの席順（North/East/South/West）をデータベースに永続化し、ゲーム履歴詳細画面で各プレイヤーの席順を表示する機能を実装する。

## 背景

現在、プレイヤーの席順は以下の課題がある：
- 席順情報はゲーム実行時のメモリ上でのみ管理されている
- データベースには`displayOrder`（1-4）のみ保存されており、実際の席順（North/East/South/West）が保存されていない
- ゲーム履歴詳細画面で各プレイヤーがどの席に座っていたかが確認できない

## 目標

1. **DB構造変更**: GameSessionテーブルに席順フィールドを追加
2. **席順永続化**: ゲーム開始時にプレイヤーの席順をDBに保存
3. **履歴表示**: ゲーム履歴詳細画面でプレイヤーの席順を表示
4. **テスト網羅**: 変更箇所の包括的な単体テスト実装

## 実装ステップ

### Step 1: 分析・設計フェーズ

#### 1.1 現状分析タスク
- [ ] 1.1.1 現在の席順管理フローの詳細分析
- [ ] 1.1.2 GameSessionテーブルの現在の利用状況確認
- [ ] 1.1.3 ゲーム履歴詳細画面の現在の表示内容確認
- [ ] 1.1.4 Socket.ioイベントでの席順情報送信状況確認

#### 1.2 設計作業
- [ ] 1.2.1 DB設計変更案作成（GameSessionテーブル拡張）
- [ ] 1.2.2 API仕様設計（ゲーム詳細レスポンスに席順追加）
- [ ] 1.2.3 フロントエンド表示仕様設計（履歴画面レイアウト）
- [ ] 1.2.4 データマイグレーション戦略策定

### Step 2: データベース構造変更

#### 2.1 Prismaスキーマ更新
- [ ] 2.1.1 GameSessionモデルに`playerPosition`フィールド追加
  ```prisma
  model GameSession {
    // 既存フィールド...
    playerPosition String? @map("player_position") // 'North', 'East', 'South', 'West'
  }
  ```
- [ ] 2.1.2 PlayerPosition enum定義をPrismaスキーマに追加
- [ ] 2.1.3 スキーマバリデーション実行

#### 2.2 マイグレーション作成・実行
- [ ] 2.2.1 Prismaマイグレーションファイル生成
- [ ] 2.2.2 マイグレーション内容確認・調整
- [ ] 2.2.3 開発環境でマイグレーション実行
- [ ] 2.2.4 既存データへの影響確認

#### 2.3 シードデータ更新
- [ ] 2.3.1 seed.tsでのGameSession作成例追加（席順含む）
- [ ] 2.3.2 テスト用ゲームデータ作成（席順情報付き）

### Step 3: バックエンドテスト実装（TDD）

#### 3.1 Repository層テスト
- [ ] 3.1.1 `GameSessionRepository.create()` 席順保存テスト作成
- [ ] 3.1.2 `GameSessionRepository.findByGameId()` 席順取得テスト作成
- [ ] 3.1.3 `GameRepository.getGameDetail()` 席順含む詳細取得テスト作成

#### 3.2 Service層テスト
- [ ] 3.2.1 `GamePersistenceService.saveGameSession()` 席順永続化テスト作成
- [ ] 3.2.2 `GameService.getGameDetail()` 席順情報含むレスポンステスト作成

#### 3.3 GameEngine/GameStateテスト
- [ ] 3.3.1 `PlayerManager.addPlayer()` 席順割り当てテスト作成
- [ ] 3.3.2 ゲーム開始時の席順保存処理テスト作成
- [ ] 3.3.3 席順による交換・手番処理の既存テスト確認

#### 3.4 API層テスト
- [ ] 3.4.1 `GET /api/games/:id` 席順情報レスポンステスト作成
- [ ] 3.4.2 Socket.ioイベント席順情報テスト作成

### Step 4: バックエンド実装

#### 4.1 Repository層実装
- [ ] 4.1.1 `IGameSessionRepository` インターフェース更新（席順フィールド追加）
- [ ] 4.1.2 `GameSessionRepository` 席順保存・取得メソッド実装
- [ ] 4.1.3 `GameRepository.getGameDetail()` 席順情報含む詳細取得実装

#### 4.2 型定義更新
- [ ] 4.2.1 `backend/src/types/index.ts` の関連型に席順フィールド追加
- [ ] 4.2.2 Socket.ioイベント型定義に席順情報追加
- [ ] 4.2.3 APIレスポンス型に席順情報追加

#### 4.3 GameEngine/PlayerManager実装
- [ ] 4.3.1 `PlayerManager.addPlayer()` で席順を確定的に割り当て
- [ ] 4.3.2 席順情報をGamePersistenceServiceに送信
- [ ] 4.3.3 ゲーム復帰時の席順復元処理実装

#### 4.4 Service層実装
- [ ] 4.4.1 `GamePersistenceService.saveGameSession()` 席順保存処理追加
- [ ] 4.4.2 `GameService.getGameDetail()` 席順情報をレスポンスに追加
- [ ] 4.4.3 `GameService.joinGame()` 席順割り当て・保存処理追加

### Step 5: フロントエンド実装

#### 5.1 型定義更新
- [ ] 5.1.1 `frontend/src/types/index.ts` に席順関連型追加
- [ ] 5.1.2 ゲーム詳細API型定義に席順フィールド追加

#### 5.2 フロントエンドテスト実装
- [ ] 5.2.1 ゲーム履歴詳細画面の席順表示テスト作成
- [ ] 5.2.2 `useGameDetail` フック席順データ処理テスト作成
- [ ] 5.2.3 席順表示コンポーネントのユニットテスト作成

#### 5.3 履歴詳細画面UI実装
- [ ] 5.3.1 ゲーム履歴詳細画面にプレイヤー席順セクション追加
- [ ] 5.3.2 席順表示コンポーネント作成（位置図式表示）
- [ ] 5.3.3 プレイヤー情報テーブルに席順カラム追加
- [ ] 5.3.4 レスポンシブデザイン対応

#### 5.4 API統合
- [ ] 5.4.1 `useGameDetail` フックで席順データ取得・管理
- [ ] 5.4.2 ゲーム詳細API呼び出し更新
- [ ] 5.4.3 エラーハンドリング（席順データなしの場合）

### Step 6: 統合テスト・品質確認

#### 6.1 End-to-Endテスト
- [ ] 6.1.1 新規ゲーム作成から席順保存までのフローテスト
- [ ] 6.1.2 ゲーム履歴詳細画面での席順表示テスト
- [ ] 6.1.3 既存ゲーム（席順なし）の表示テスト
- [ ] 6.1.4 複数ゲームでの席順の独立性確認

#### 6.2 パフォーマンステスト
- [ ] 6.2.1 席順データ追加によるAPI応答速度確認
- [ ] 6.2.2 DB容量増加の確認
- [ ] 6.2.3 フロントエンド描画パフォーマンス確認

#### 6.3 データ整合性確認
- [ ] 6.3.1 既存ゲームデータへの影響なし確認
- [ ] 6.3.2 マイグレーション前後のデータ一貫性確認
- [ ] 6.3.3 席順データの重複・欠損チェック

### Step 7: ドキュメント・最終化

#### 7.1 ドキュメント更新
- [ ] 7.1.1 APIドキュメント更新（席順フィールド追加）
- [ ] 7.1.2 データベース仕様書更新
- [ ] 7.1.3 ゲーム仕様書の席順管理章更新

#### 7.2 品質確認
- [ ] 7.2.1 全テスト実行・合格確認
- [ ] 7.2.2 ESLint・TypeScript型チェック
- [ ] 7.2.3 コードレビュー実施

## 成功基準

### 機能要件
- [x] プレイヤーの席順がデータベースに正確に保存される
- [x] ゲーム履歴詳細画面で各プレイヤーの席順が視覚的に分かりやすく表示される
- [x] 既存のゲーム機能に影響を与えない
- [x] 席順データが存在しない既存ゲームでも正常に表示される

### 技術要件
- [x] 全テストが合格状態を維持
- [x] API応答時間が既存レベルを維持（+100ms以内）
- [x] 型安全性が保たれている
- [x] データベースの整合性が保たれている

### 品質要件
- [x] 新機能のテストカバレッジ90%以上
- [x] ESLint・Prettierルール遵守
- [x] レスポンシブデザイン対応

## リスク・対策

### 技術リスク
- **既存データとの互換性**: マイグレーション時のデータ整合性確保
- **パフォーマンス影響**: GameSessionテーブル肥大化への対策
- **UI表示の複雑化**: シンプルで分かりやすい席順表示設計

### 対策
- 段階的マイグレーション実行
- データベースインデックス最適化
- ユーザビリティテスト実施

## 推定工数

- **設計・分析**: 0.5日
- **バックエンド実装**: 2.0日（テスト含む）
- **フロントエンド実装**: 1.5日（テスト含む）
- **統合テスト・品質確認**: 1.0日
- **合計**: 5.0日

## 依存関係

- **前提条件**: Phase 13（データ永続化詳細）の完了
- **影響する機能**: ゲーム履歴機能、ゲーム復帰機能
- **並行実装可能**: Phase 15（ゲーム履歴表示画面改善）の他の要素

## 後続フェーズへの影響

この実装により以下のフェーズが円滑に進行できる：
- **Phase 15**: より詳細なゲーム履歴表示機能
- **将来の統計機能**: プレイヤー位置別の成績分析など