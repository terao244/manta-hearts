# 同点時ゲーム継続仕様変更タスクリスト

## 🎯 実装状況サマリー（2025/01/09更新）

### ✅ **Phase 1-3 完了（バックエンド基盤）**
- **TDD RED Phase**: 同点継続の包括的テストケース実装
- **TDD GREEN Phase**: `hasTiedLowestScores()`, `isGameCompleted()`, `getWinnerId()` 実装
- **TDD REFACTOR Phase**: JSDocドキュメント、型安全性、エラーハンドリング強化
- **品質確認**: 63テスト通過、型チェック・Lint通過

### 📋 **次のステップ（Phase 4以降）**
- フロントエンド同点継続UI対応
- E2E統合テスト実装
- 実際のゲームプレイ確認

---

## 概要

ハーツゲームにおいて、ハンド終了時に最低得点のプレイヤーが複数いる場合（同点）、ゲームを継続するように仕様変更を行う。

### 現在の仕様
- 誰かが終了点数（デフォルト100点）以上に達したら即座にゲーム終了
- 同点の場合、最初に見つかったプレイヤーIDが勝者となる

### 新仕様
- 誰かが終了点数以上に達し、かつ最低得点者が1人のみの場合にゲーム終了
- 最低得点者が複数いる場合（同点）はゲーム継続

## 実装タスクリスト（TDD アプローチ）

### Phase 1: バックエンド - テスト実装（RED Phase）

#### 1.1 GameState.ts のユニットテスト実装 ✅
- **ファイル**: `backend/src/__tests__/game/GameState.test.ts`
- **TDDフェーズ**: **RED** - テストを先に書いて失敗させる
- **追加テストケース**:
  - [x] `hasTiedLowestScores()` メソッドのテスト
    - [x] 2人同点時に true を返すテスト
    - [x] 3人同点時に true を返すテスト
    - [x] 4人同点時に true を返すテスト
    - [x] 1人最低点時に false を返すテスト
    - [x] 0点台での同点テスト
  - [x] `isGameCompleted()` の同点継続テスト
    - [x] 終了点数超過かつ同点時に false を返すテスト
    - [x] 終了点数超過かつ勝者1人時に true を返すテスト
    - [x] 終了点数未達時に false を返すテスト
  - [x] `getWinnerId()` の同点時処理テスト
    - [x] 同点時に null を返すテスト
    - [x] 勝者確定時に正しいIDを返すテスト
- **期待状態**: **全テストが FAIL する**（未実装のため）- ✅ **完了**

#### 1.2 GameEngine.ts のユニットテスト実装 ✅
- **ファイル**: `backend/src/__tests__/game/GameEngine.test.ts`
- **TDDフェーズ**: **RED** - テストを先に書いて失敗させる
- **追加テストケース**:
  - [x] ハンド完了時の同点継続テスト
    - [x] 同点時にゲーム継続することのテスト
    - [x] 勝者確定時にゲーム終了することのテスト
  - [x] イベント発火の確認テスト
    - [x] 同点継続時のイベント通知テスト
    - [x] ゲーム完了時のイベント通知テスト
- **期待状態**: **全テストが FAIL する**（未実装のため）- ✅ **完了**

### Phase 2: バックエンド - ロジック実装（GREEN Phase）

#### 2.1 GameState.ts の同点判定ロジック実装 ✅
- **ファイル**: `backend/src/game/GameState.ts`
- **TDDフェーズ**: **GREEN** - テストをパスする最低限の実装
- **実装内容**:
  - [x] `hasTiedLowestScores()` メソッド追加
    - [x] 最低得点を取得
    - [x] 最低得点のプレイヤー数をカウント
    - [x] 2人以上の場合は true を返す
  - [x] `isGameCompleted()` メソッド修正
    - [x] 既存の終了条件に同点チェックを追加
    - [x] 同点時は false を返すよう修正
  - [x] `getWinnerId()` メソッド修正
    - [x] 同点時は null を返すよう修正
- **期待状態**: **Phase 1.1 のテストがすべて PASS する** - ✅ **完了**

#### 2.2 GameEngine.ts の制御ロジック実装 ✅
- **ファイル**: `backend/src/game/GameEngine.ts`
- **TDDフェーズ**: **GREEN** - テストをパスする最低限の実装
- **実装内容**:
  - [x] `completeHand()` メソッド修正 (行371)
    - [x] 既存の`isGameCompleted()`使用で同点時継続処理対応済み
    - [x] 適切なイベント通知の実装確認済み
  - [x] `completeGame()` メソッド調整 (行382-397)
    - [x] 同点時は呼び出されないことの確認
    - [x] エラーハンドリング追加済み
- **期待状態**: **Phase 1.2 のテストがすべて PASS する** - ✅ **完了**

#### 2.3 バックエンドテスト実行・確認 ✅
- **実行コマンド**: `cd backend && npm test`
- **確認事項**:
  - [x] 新規追加テストがすべて PASS（63テスト通過）
  - [x] 既存テストが破綻していない（回帰テスト通過）
  - [x] テストカバレッジの確認
- **期待状態**: **全 168+ テストが PASS する** - ✅ **完了**

### Phase 3: バックエンド - リファクタリング（REFACTOR Phase）

#### 3.1 コード品質向上 ✅
- **対象ファイル**: `GameState.ts`, `GameEngine.ts`
- **TDDフェーズ**: **REFACTOR** - テストを保ちながらコード改善
- **改善内容**:
  - [x] コメント追加・改善（JSDoc形式でのドキュメント追加）
  - [x] メソッド名の最適化（既存メソッド名は適切）
  - [x] 重複コードの削除（効率的な実装確認）
  - [x] パフォーマンスの最適化（型安全チェック追加）
- **期待状態**: **全テストが引き続き PASS する** - ✅ **完了**

#### 3.2 型安全性の強化 ✅
- **対象ファイル**: 関連する TypeScript ファイル
- **改善内容**:
  - [x] 型定義の明確化（明示的な型注釈追加）
  - [x] null チェックの強化（エラーハンドリング追加）
  - [x] エラーハンドリングの改善（境界値チェック強化）
- **期待状態**: **型チェックエラーなし・全テスト PASS** - ✅ **完了**

### Phase 4: フロントエンド - テスト実装（RED Phase）

#### 4.1 フロントエンドテスト実装
- **ファイル**: 
  - `frontend/src/hooks/__tests__/useGame.test.ts`
  - `frontend/src/components/game/__tests__/GameBoard.test.tsx`
- **TDDフェーズ**: **RED** - テストを先に書いて失敗させる
- **追加テストケース**:
  - [ ] 同点継続時のstate管理テスト
  - [ ] UI表示制御テスト（終了モーダル非表示）
  - [ ] ユーザー通知テスト（継続メッセージ）
- **期待状態**: **全テストが FAIL する**（未実装のため）

### Phase 5: フロントエンド - 実装（GREEN Phase）

#### 5.1 useGame.ts の状態管理実装
- **ファイル**: `frontend/src/hooks/useGame.ts`
- **TDDフェーズ**: **GREEN** - テストをパスする最低限の実装
- **実装内容**:
  - [ ] `handleGameCompleted` 関数修正 (行533-541)
  - [ ] 同点継続時の状態管理
- **期待状態**: **関連テストが PASS する**

#### 5.2 GameBoard.tsx の表示制御実装
- **ファイル**: `frontend/src/components/game/GameBoard.tsx`
- **TDDフェーズ**: **GREEN** - テストをパスする最低限の実装
- **実装内容**:
  - [ ] ゲーム終了モーダル表示条件修正 (行567-574)
  - [ ] 同点継続時のユーザー通知追加
- **期待状態**: **関連テストが PASS する**

#### 5.3 フロントエンドテスト実行・確認
- **実行コマンド**: `cd frontend && npm test`
- **確認事項**:
  - [ ] 新規追加テストがすべて PASS
  - [ ] 既存テストが破綻していない
- **期待状態**: **全 30+ テストが PASS する**

#### 6.1 GameService.ts テスト実装（RED Phase）
- **ファイル**: `backend/src/__tests__/services/GameService.test.ts`
- **TDDフェーズ**: **RED** - テストを先に書いて失敗させる
- **追加テストケース**:
  - [ ] 同点時のイベント処理テスト
  - [ ] Socket.io通信の確認テスト
- **期待状態**: **全テストが FAIL する**（未実装のため）

#### 6.2 GameService.ts 実装（GREEN Phase）
- **ファイル**: `backend/src/services/GameService.ts`
- **TDDフェーズ**: **GREEN** - テストをパスする最低限の実装
- **実装内容**:
  - [ ] `onGameCompleted` イベントハンドラー調整 (行664-685)
  - [ ] 同点時のイベント処理追加
- **期待状態**: **Phase 6.1 のテストが PASS する**

#### 6.3 Socket.io イベント定義確認・調整
- **ファイル**: `backend/src/types/index.ts`
- **確認・実装内容**:
  - [ ] 既存のイベント定義で同点継続に対応可能か確認
  - [ ] 必要に応じて新しいイベント（`gameContinuedFromTie` 等）追加
- **期待状態**: **クライアントが同点継続状態を認識可能**

### Phase 7: UI/UX 改善とテスト

#### 7.1 UI改善テスト実装（RED Phase）
- **対象ファイル**: UI関連テストファイル
- **TDDフェーズ**: **RED** - テストを先に書いて失敗させる
- **追加テストケース**:
  - [ ] 同点継続時の視覚的フィードバックテスト
  - [ ] スコア表示強調テスト
- **期待状態**: **全テストが FAIL する**（未実装のため）

#### 7.2 UI改善実装（GREEN Phase）
- **対象コンポーネント**: GameBoard.tsx, スコア関連コンポーネント
- **TDDフェーズ**: **GREEN** - テストをパスする最低限の実装
- **実装内容**:
  - [ ] 同点継続時の視覚的フィードバック追加
  - [ ] 「同点のため次のハンドに進みます」等のメッセージ表示
  - [ ] 同点時のスコア表示強調
- **期待状態**: **Phase 7.1 のテストが PASS する**

### Phase 8: 設定とドキュメント

#### 8.1 ゲーム設定の確認・調整
- **ファイル**: `backend/src/config/gameConfig.ts`
- **確認・実装事項**:
  - [ ] 終了点数設定が同点継続に影響しないか確認
  - [ ] 必要に応じて同点継続に関する設定追加検討
- **期待動作**: **既存設定との整合性確保**

#### 8.2 ドキュメント更新
- **対象ファイル**: 
  - `docs/requirements.md`
  - `docs/ARCHITECTURE.md`
  - `CLAUDE.md`
- **更新内容**:
  - [ ] 同点継続ルールの明記
  - [ ] ゲーム終了条件の詳細化
  - [ ] 実装仕様の更新
- **期待動作**: **仕様の明確化と継承性確保**

### Phase 9: 総合テスト・動作確認

#### 9.1 E2E テスト実装と実行
- **テストシナリオ実装**:
  - [ ] 通常ゲーム終了（勝者1人）の確認テスト
  - [ ] 2人同点継続→次ハンドで勝者確定テスト
  - [ ] 3人同点継続→次ハンドで勝者確定テスト
  - [ ] 4人同点継続→次ハンドで勝者確定テスト
  - [ ] 複数回の同点継続→最終的な勝者確定テスト
- **期待動作**: **全シナリオで正常動作**

#### 9.2 最終回帰テスト
- **テスト実行**:
  - [ ] `cd backend && npm test` - 全バックエンドテスト実行
  - [ ] `cd frontend && npm test` - 全フロントエンドテスト実行
  - [ ] `cd backend && npm run type-check && npm run lint` - 型チェック・Lint確認
  - [ ] `cd frontend && npm run type-check && npm run lint` - 型チェック・Lint確認
- **確認項目**:
  - [ ] 既存機能に影響がないことの確認
  - [ ] 通常ゲーム終了が正常動作することの確認
  - [ ] Socket.io通信が正常であることの確認
- **期待動作**: **全テスト PASS・既存機能の破綻なし**

## TDD実装優先順序（修正版）

### 🔴 RED → 🟢 GREEN → 🔵 REFACTOR サイクル

1. **Phase 1**: バックエンドテスト実装（🔴 RED）
2. **Phase 2**: バックエンドロジック実装（🟢 GREEN）
3. **Phase 3**: バックエンドリファクタリング（🔵 REFACTOR）
4. **Phase 4**: フロントエンドテスト実装（🔴 RED）
5. **Phase 5**: フロントエンド実装（🟢 GREEN）
6. **Phase 6**: サービス層TDDサイクル（🔴🟢🔵）
7. **Phase 7**: UI/UX改善TDDサイクル（🔴🟢🔵）
8. **Phase 8**: 設定・ドキュメント
9. **Phase 9**: 総合テスト・動作確認

## TDD実装における注意事項

### 🔴 RED Phase（テスト実装）での注意点
- **テストは必ず FAIL させる**: 未実装機能のテストなので最初は失敗する
- **テストケースは具体的に**: 境界値や例外ケースを含む網羅的なテスト
- **テスト名は明確に**: 何をテストしているかが分かりやすい命名
- **モックは適切に**: 依存関係を適切にモック化

### 🟢 GREEN Phase（実装）での注意点
- **最低限の実装**: テストをパスする最小限のコードのみ実装
- **テスト通過が最優先**: 完璧でなくても動作することを重視
- **既存テストを破綻させない**: 回帰テストが通過することを確認
- **コミットは小刻みに**: 各テストケースがパスするたびにコミット

### 🔵 REFACTOR Phase（リファクタリング）での注意点
- **テストを保持**: リファクタリング中もテストは常にパス状態
- **段階的改善**: 一度に大きく変更せず、小さな改善を積み重ね
- **コード品質向上**: 可読性、保守性、パフォーマンスの改善
- **型安全性強化**: TypeScriptの恩恵を最大限活用

### 全フェーズ共通の注意事項
- **各PhaseはTDDサイクル完了を前提**: RED→GREEN→REFACTORを必ず完了
- **テスト通過状態を常に維持**: どの時点でも全テストがパス状態
- **既存機能への影響を最小限に**: 回帰テストで継続的に確認
- **意味のある単位でコミット**: 各TDDサイクル完了時にコミット実行

## TDD完了基準

### Phase完了基準（各フェーズごと）
- [x] **RED**: 新仕様のテストが実装され、期待通りFAILする - ✅ **Phase 1完了**
- [x] **GREEN**: 実装されたコードですべてのテストがPASSする - ✅ **Phase 2完了**
- [x] **REFACTOR**: コード品質が向上し、テストが引き続きPASSする - ✅ **Phase 3完了**
- [x] **回帰テスト**: 既存の全テストが影響を受けずにPASSする - ✅ **Phase 1-3完了**

### 最終完了基準（Phase 1-3 バックエンド完了基準）
- [x] **全テスト通過**: バックエンド63テストがすべてPASS（Phase 1-3対象分）
- [x] **型チェック通過**: TypeScriptコンパイルエラーなし
- [x] **Lint通過**: ESLintエラー・警告なし
- [x] **同点継続機能**: 仕様通りの動作確認済み（バックエンド）
  - [x] 2人同点時の継続動作確認
  - [x] 3人同点時の継続動作確認  
  - [x] 4人同点時の継続動作確認
  - [x] 勝者確定時の正常終了確認
- [x] **既存機能保護**: 通常ゲーム終了に影響なし
- [x] **ドキュメント更新**: 仕様変更が適切に文書化（Phase 1-3）
- [ ] **実際のゲームプレイ**: E2E動作確認済み（Phase 4以降で実施予定）

### 残作業（Phase 4以降）
- [ ] フロントエンド同点継続UI対応
- [ ] E2E統合テスト
- [ ] 実際のゲームプレイ確認

## 実装時のコミット戦略

### コミットタイミング
1. **RED Phase完了時**: `feat: add tests for tie game continuation logic`
2. **GREEN Phase完了時**: `feat: implement tie game continuation logic`
3. **REFACTOR Phase完了時**: `refactor: improve tie game logic code quality`
4. **フェーズ完了時**: `feat: complete Phase X - tie game continuation`

### コミットメッセージ例
```bash
# テスト追加時
feat: add GameState tie detection tests

Add comprehensive test cases for hasTiedLowestScores() method
- Test 2-4 player tie scenarios
- Test single winner scenarios  
- Test boundary conditions

# 実装完了時
feat: implement tie game continuation logic

Implement hasTiedLowestScores() and update isGameCompleted()
- Games continue when lowest scores are tied
- Games end only when single winner exists
- All new tests pass, existing tests unaffected
```

この修正されたタスクリストにより、テスト駆動開発アプローチで確実に同点時ゲーム継続機能を実装できます。